---
title: Fyrirlestur 6.2 ‚Äî Vef√æj√≥nustur
---

# Fyrirlestur 6.2 ‚Äî Vef√æj√≥nustur

## Vefforritun 2 ‚Äî HBV403G

### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## REST og express

* Express getur au√∞veldlega sent fr√° s√©r JSON
  - `res.json({ data: 'foo' });`
* Express kemur me√∞ JSON body parser middleware
  - `app.use(express.json());`
  - Getum teki√∞ vi√∞ JSON fr√° client
* Fyrir skr√°a upload √æurfum vi√∞ samt enn√æ√° middleware sem sty√∞ur multipart

***

## GET

* S√¶kir allar f√¶rslur e√∞a staka f√¶rslu
* Ef f√¶rslur/f√¶rsla finnst, skilum `200 OK`
* Ef f√¶rsla finnst ekki, skilum `404 Not Found`

***

* Miki√∞ nota√∞ pattern a√∞ s√¶kja eitthva√∞ √° sl√≥√∞, t.d. `/items` til a√∞ f√° fylki af hlutum
* Gettum `/items/:id` til a√∞ f√° staka f√¶rslu sem hlut

***

`GET /`

```json
[
  {
    "id": 1,
    "title": "Foo"
  },
  {
    "id": 2,
    "title": "Bar"
  }
]
```

***

`GET /1`

```json
{
  "id": 1,
  "title": "Foo"
}
```

***

## POST

* B√Ωr til n√Ωja f√¶rslu √∫tfr√° gefnu JSON
* Ef f√¶rsla er l√∂gleg, skilum `201 Created`, stundum me√∞ f√¶rslu
* Ef f√¶rsla er ekki l√∂gleg (t.d. g√∂gn eru ekki gild), skilum `400 Bad Request`
* √ûurfum a√∞ passa upp √° JSON villur fr√° notanda

***

## Express og JSON villur

* Ef notandi sendir JSON √æarf a√∞ t√∫lka √æa√∞
  - Villur √≠ JSON munu kasta keyrslu villu og √°n √æess a√∞ breg√∞ast vi√∞ √æv√≠ myndum vi√∞ senda `500 Internal Server Error` √æegar villan liggur hj√° notanda (400 villa!)
* Getum b√¶tt vi√∞ athugun √≠ villume√∞h√∂ndlun sem l√¶tur vita

***
<!-- eslint-disable no-undef -->

```javascript
if (err instanceof SyntaxError &&
    err.status === 400 && 'body' in err) {
  res
    .status(400)
    .json({ error: 'Invalid json' });
}
```

***

## 404 villur

Skilum `404` status k√≥√∞a og skilabo√∞um √≠ JSON ef route finnst ekki.

<!-- eslint-disable no-unused-vars, no-undef -->

```js
function notFoundHandler(req, res, next) {
  console.warn('Not found', req.originalUrl);
  res.status(404).json({ error: 'Not found' });
}
app.use(notFoundHandler);
```

***

## PUT

* Uppf√¶rir f√¶rslu a√∞ √∂llu leiti me√∞ gefnu JSON
* Ef f√¶rsla finnst ekki, skilum `404 Not Found`
* Ef f√¶rsla er l√∂gleg, skilum `200 OK`, stundum me√∞ f√¶rslu
* Ef f√¶rsla er ekki l√∂gleg (t.d. g√∂gn eru ekki gild), skilum `400 Bad Request`

***

## PATCH

* Uppf√¶rir f√¶rslu a√∞ einhverju leiti me√∞ gefnu JSON
* Ef f√¶rsla finnst ekki, skilum `404 Not Found`
* Ef f√¶rsla er l√∂gleg, skilum `200 OK`, stundum me√∞ f√¶rslu
* Ef f√¶rsla er ekki l√∂gleg (t.d. g√∂gn eru ekki gild), skilum `400 Bad Request`

***

* √ûar sem `PATCH` uppf√¶rir hluta af g√∂gnum getur √æa√∞ or√∞i√∞ vesen
* √ûurfum a√∞ vita hva√∞a g√∂gn √° a√∞ uppf√¶ra og passa upp √° a√∞ uppf√¶ra _a√∞eins_ √æau g√∂gn
* √ûurfum a√∞ √∫tb√∫a _d√Ωnam√≠skar_ sql fyrirspurnir ef vi√∞ erum a√∞ nota gagnagrunn

***

## DELETE

* Ey√∞ir f√¶rslu
* Ef f√¶rsla finnst ekki, skilum `404 Not Found`
* Annars skilum vi√∞ `204 No Content` me√∞ t√≥ma JSON

---

## H√∂nnun √° vefj√æ√≥nustum

* T√∂luvert √≥l√≠kt √æv√≠ a√∞ hanna vefi me√∞ √∫tliti
* Neytendur okkar eru a√∞rir forritarar og √æeirra forrit
  - Mun minna r√Ωmi til a√∞ t√∫lka eitthva√∞ eins og villu √° vef
  - Getum spara√∞ √∂√∞rum _√≥tr√∫lega_ mikinn t√≠ma me√∞ √æv√≠ a√∞ vanda okkur

***

* √ûurfum a√∞ hugsa vel um samr√¶mi
  - Samr√¶mi √° heitum (ekki `username`, `userName` og `user-name`)
  - Samr√¶mi √° URI (ekki `/get-users`, `/products` og `/cats`)
  - Samr√¶mi √° villuskilabo√∞um

***

* Hugsum heildst√¶tt, hva√∞ gerist √≠ hverju tilfelli?
  - Hva√∞ ef be√∞i√∞ er um eitthva√∞ sem er ekki til
  - Hva√∞ ef villa kemur upp
  - o.s.fr.
* Oft gott a√∞ a√∞skilja virknina okkar fr√° vef√æj√≥nustulaginu
  - Vef√æj√≥nustan kemur sem ‚Äû√æunnt lag‚Äú ofan √° virkni

---

## D√Ωnam√≠skar fyrirspurnir

* Stundum √æurfum vi√∞ a√∞ gr√≠pa til √æess a√∞ b√∫a til fyrirspurnir me√∞ strengjame√∞h√∂ndlun üôà
* Ekki allt getur fari√∞ √≠ prepared statement, t.d. ef vi√∞ viljum d√Ωnam√≠skt breyta `ORDER BY`
* E√∞a gera `PATCH` k√∂ll
* **VER√êUM A√ê FARA VARLEGA**, svona k√≥√∞i er einstaklega vi√∞kv√¶mur fyrir SQL injection

***

<!-- eslint-disable no-unused-vars, no-undef -->

```javascript
async function list(req, res) {
  const asc = req.query.order === 'ASC';

  // r√∂√∞um eftir id √≠ ascending (ASC) e√∞a descending
  // (DESC) r√∂√∞ eftir √æv√≠ hvort boolean gildi s√©
  // satt e√∞a ekki
  // Notum ekkert fr√° notanda √≠ d√Ωnam√≠skr√≠ fyrirsp.
  // GETUM A√êEINS HAFT TV√ñ GILDI!
  const order = asc ? 'id ASC' : 'id DESC';

  const q = `SELECT * FROM items ORDER BY ${order}`;

  const result = await query(q);
}
```

***

## F√¶rslur b√∫nar til

* Getum nota√∞ `RETURNING` syntax √≠ postgres til a√∞ f√° til baka f√¶rslu sem b√∫in var til
* √ûurfum ekki a√∞ra fyrirspurn til a√∞ fletta upp reitum eins og `id` e√∞a `created`
* `INSERT INTO items (text) VALUES ('foo') RETURNING id, text, created;`

***

## F√¶rslum eytt

* Getum reynt a√∞ ey√∞a f√¶rslu sem er ekki til
  - √ûurfum samt a√∞ a√∞skilja √° milli f√¶rslu sem var til og eytt
  - og f√¶rslu sem var ekki til...
* √ûegar √°tt var vi√∞ ra√∞ir mun `rowCount` skila fj√∂lda ra√∞a sem √°tt var vi√∞

***

<!-- eslint-disable no-unused-vars, no-undef -->

```javascript
async function deleteRow(id) {
  const q = 'DELETE FROM todos WHERE id = $1';

  const result = await query(q, [id]);

  // true ef f√¶rslu eytt, annars false
  return result.rowCount === 1;
}
```
