---
title: Fyrirlestur 3.3 ‚Äì Postgres
---

# Fyrirlestur 3.1 ‚Äî Postgres

## Vefforritun 2 ‚Äî HBV403G

### √ìlafur Sverrir Kjartansson, [osk@hi.is](mailto:osk@hi.is)

---

## [PostgreSQL](https://en.wikipedia.org/wiki/PostgreSQL)

* E√∞a bara _postgres_
* Open source gagnagrunnur sem er mj√∂g √∫tbreiddur og miki√∞ nota√∞ur
* _Object-relational database management system_ (ORDBMS), miki√∞ af s√©rt√¶kri, kr√∂ftugri virkni
* _ACID_ og √∫tf√¶rir mest allan SQL sta√∞alinn

***

## Postgres t√Ωpur

* Sty√∞ur margar ger√∞ir af t√Ωpum
  - Fylki, JSON, geometr√≠skar o.fl.
* Einfaldari t√Ωpur:
  - [T√∂lulegar](http://www.postgresql.org/docs/current/static/datatype-numeric.html) (integer, serial)
  - [Stafi](http://www.postgresql.org/docs/current/static/datatype-character.html) (char, varchar, text)
  - [Dagsetningar](http://www.postgresql.org/docs/current/static/datatype-datetime.html) (timestamp with time zone)
* [Yfirlit yfir t√Ωpur](http://www.postgresql.org/docs/current/static/datatype.html)

***

## Postgres ‚Äì uppsetning

* S√¶kjum og setjum upp postgres fr√° [postgresql.org](http://www.postgresql.org/)
  - http://www.postgresql.org/download/
* √Å macOS er gott a√∞ nota [homebrew](http://brew.sh/) til a√∞ setja upp
  - `brew install postgres`
  - `brew services start postgresql` til a√∞ kveikja √° √æj√≥nustu

***

* Getum lent √≠ vandr√¶√∞um me√∞ uppsetningu
  - S√©r √≠ lagi me√∞ notendast√Ωringu
* T√≥kum saman nokkur atri√∞i sem nemendur lentu √≠ vi√∞ uppsetningu √≠ fyrra
  - [‚ÄûA√∞ tengjast postgres‚Äú](itarefni/postgres.md)

***

## psql

* `psql` er CLI a√∞gangur a√∞ Postgres
* Getum gert allar a√∞ger√∞ir, en getur teki√∞ t√≠ma a√∞ l√¶ra √° og venjast
* [PostgreSQL on the command-line](http://phili.pe/posts/postgresql-on-the-command-line/)

***

## pgAdmin

* [pgAdmin](http://www.pgadmin.org/) er graf√≠skt vi√∞m√≥t ofan √° postgres
* [S√¶kjum s√©rstaklega fyrir Windows og Mac](http://www.pgadmin.org/download/) fylgir me√∞ flestum √∫tg√°fum af Linux
* Getum √∫tb√∫i√∞ gagnagrunna, t√∂flur og allskonar

***

## Syntax

* Notar SQL me√∞ vi√∞b√≥tum
* √ñll verkefni munu byggja √° s√©√∞um d√¶mum, n√≥g a√∞ breyta √æeim (heitum, fj√∂lda d√°lka o.s.fr.) til a√∞ leysa
* Mun b√¶tast vi√∞ eftir √æv√≠ sem vi√∞ h√∂ldum √°fram

***

```sql
-- SQL Athugasemd √≠ einni l√≠nu
/*
  SQL athugasemd
  √≠ m√∂rgum l√≠num
*/
SELECT * FROM table; -- ; er seg√∞aendir
select * from table; -- Ekki case sensitive
```

***

## T√∂flur

* T√∂flur samanstanda af d√°lkum og r√∂√∞um
* D√°lkar eru vel skilgreindir me√∞ t√Ωpum, takm√∂rkunum og √Ωmsum √∂√∞rum l√Ωsig√∂gnum
* Ra√∞ir eru √æau g√∂gn sem vi√∞ b√¶tum vi√∞ t√∂fluna
  - Getum haft t√∂flur me√∞ engum r√∂√∞um upp √≠ tugmilj√≥nir e√∞a meira

***

## B√∫a til t√∂flu ([create table](https://www.postgresql.org/docs/current/static/sql-createtable.html))

```sql
CREATE TABLE people(
  id serial primary key,
  name varchar(64) not null unique,
  text text,
  registered boolean default false,
  date timestamp with time zone not null
    default current_timestamp
);
```

***

* Getum keyrt skipun a√∞ ofan eftir a√∞ vi√∞ tengjumst me√∞ `psql`
* Ef vi√∞ notum GUI t√≥l sko√∞um vi√∞ t√∂flur undir:
  - `Schemas > public > tables`
  - E√∞a nota√∞ query t√≥l. √ç pgAdmin, h√¶gri smella √° gagnagrunn og `Query Tool`

***

* `id serial primary key` b√Ωr til _primary key_ d√°lk sem heitir `id`
  - Einstakur fyrir √æessa t√∂flu, engar tv√¶r ra√∞ir hafa sama primary key
  - √ûurfum ekki gera neitt √≠ `insert`, h√¶kkar sj√°lfkrafa

***

* `name varchar(64) not null unique` b√Ωr til d√°lk `name` me√∞ _variable characters_, st√∂fum af mismunandi bita lengd, eins og utf8
  - Tala √≠ sviga segir til um h√°markslengd, 64 stafir √≠ √æessu tilfelli
  - `not null`, ver√∞um a√∞ skilgreina gildi √æegar vi√∞ b√¶tum vi√∞ √≠ t√∂flu
  - `unique`, engar tv√¶r ra√∞ir mega vera eins √≠ t√∂flu

***

* `text text` b√Ωr til d√°lk `text` af t√Ωpunni `text`
  - Getur haldi√∞ utan um texta af hva√∞a lengd sem er
  - Gott fyrir texta sem vi√∞ vitum ekki hve langur getur or√∞i√∞
  - Sl√¶mt fyrir d√°lka sem vi√∞ viljum b√∫a til _indexa_ fyrir
  - M√° vera t√≥mt, f√°um √æ√° `NULL`

***

* `registered boolean default false` b√Ωr til d√°lk `registered` af t√Ωpunni `boolean`
  - Getur veri√∞ `true` e√∞a `false`, ekkert anna√∞
  - `default false` leyfir okkur a√∞ sleppa √æv√≠ a√∞ tiltaka √æegar vi√∞ b√¶tum vi√∞ r√∂√∞, ver√∞ur sj√°lfgefi√∞ `false`

***

* `date timestamp with time zone not null default current_timestamp` b√Ωr til d√°lk `date`
  - T√Ωpa er `timestamp with time zone`, dagst√≠mi me√∞ time zone
  - Sj√°lfgefi√∞ er √æa√∞ _n√∫na_, s√° t√≠mi sem r√∂√∞ er b√¶tt vi√∞
  - Gott a√∞ geyma me√∞ r√∂√∞um, s√©rstaklega √æegar vi√∞ erum a√∞ taka vi√∞ fr√° notendum

***

## B√¶ta vi√∞ t√∂flu ([insert](https://www.postgresql.org/docs/current/static/sql-insert.html))

```sql
INSERT INTO people
  (name, text)
VALUES
  ('J√≥n', 'Hall√≥');
INSERT INTO people
  (name, registered)
VALUES
  ('Anna', true)
RETURNING *;
-- RETURNING skilar okkur r√∂√∞ sem var√∞ til
-- Getum vali√∞ d√°lk, sj√° a√∞ ne√∞an
```

***

## Velja √∫r t√∂flu ([select](https://www.postgresql.org/docs/current/static/sql-select.html))

```sql
-- * velur alla d√°lka
-- Tilgreinum ekki takm√∂rkun, f√°um *allar* ra√∞ir
SELECT * FROM people;
```

```sql
id | name | text  | registered |             date
---+------+-------+------------+-------------------------------
 1 | J√≥n  | Hall√≥ | f          | 2019-01-23 17:17:46.730327+00
 2 | Anna |       | t          | 2019-01-23 17:17:46.730327+00
(2 rows)
```

***

```sql
-- Tilgreinum n√°kv√¶mlega hva√∞a d√°lka vi√∞ viljum
SELECT name, registered FROM people;
```

```sql
 name | registered
------+------------
 J√≥n  | f
 Anna | t
(2 rows)
```

***

## Uppf√¶ra t√∂flu ([update](https://www.postgresql.org/docs/current/static/sql-update.html))

```sql
-- Notum where skilyr√∞i til a√∞ breyta n√°kv√¶mri r√∂√∞
-- √Ån where skilyr√∞is uppf√¶rum vi√∞ *allar* ra√∞ir
UPDATE people SET NAME = '√ìli' WHERE id = 1;
```

```sql
UPDATE 1
```

***

## Ey√∞a √∫r t√∂flu ([delete](https://www.postgresql.org/docs/current/static/sql-update.html))

```sql
-- Sama h√©r, notum where skilyr√∞i til a√∞ velja r√∂√∞
-- √Ån √æess EY√êUM VI√ê √ñLLUM F√ÜRSLUM üôÄ
DELETE FROM people WHERE id = 1;
```

```sql
DELETE 1
```

***

## CRUD

* √ûetta samansafn af a√∞ger√∞um kallast oftast _CRUD_
  - Create (√æ√° INSERT)
  - Read
  - Update
  - Delete

---

## Postgres og Node.js

* [node-postgres](https://github.com/brianc/node-postgres) er hrein JavaScript √∫tf√¶rsla af PostgresSQL client
* `npm install --save pg`
* Callback og promise vi√∞m√≥t
* Sty√∞ur _prepared statements_ sem vi√∞ notum **alltaf** til a√∞ minnka l√≠kur √° SQL injection √°r√°sum

***

## Tengjast gagnagrunni

Ef vi√∞ h√∂fum keyrandi gagnagrunn √° v√©l getum vi√∞ tengst √° nokkra vegu

* √ötb√∫a n√Ωjan `Client` og gefa uppl√Ωsingar um tengingu
* √ötb√∫a [_connection pool_](https://node-postgres.com/features/pooling) og tengjast gegnum hann
  - √Üskilegt fyrir vefforrit sem opna margar gagnagrunnstengingar

***

* Tengjast me√∞ connection streng, URI sem skilgreinir uppl√Ωsingar um hvernig tengjast skuli
  - Hentugt √æar sem allar uppl√Ωsingar eru √≠ einum streng
  - Vi√∞ notum √æetta a√∞allega √≠ okkar verkefnum

***

<!-- eslint-disable import/no-unresolved -->

```javascript
const { Client } = require('pg');

const client = new Client({
  user: '',
  host: 'localhost',
  database: 'examples-2019',
  password: '',
});
client.connect();
client.query(/* ... */);

// Ver√∞um a√∞ loka tengingu √° einhverjum t√≠mapunkti
// til a√∞ t√¶ma event loop
client.end();
```

***

<!-- eslint-disable import/no-unresolved -->

```javascript
const { Pool } = require('pg');

const connectionString =
  'postgres://:@localhost/examples-2019';

const pool = new Pool({
  connectionString,
});

pool.query();
```

***

<!-- eslint-disable import/no-unresolved -->

```javascript
const { Client } = require('pg');

const connectionString =
  'postgres://:@localhost/examples-2019';

const client = new Client({
  connectionString,
});

client.connect();
client.query();
```

***

## Callback select

<!-- eslint-disable no-undef -->

```javascript
client.query(
  'SELECT * FROM people',
  (err, res) => {
    if (err) {
      console.error(err);
      return;
    }

    console.log(res.rows);
    client.end();
  },
);
```

***

## Promise select

<!-- eslint-disable no-undef -->

```javascript
client.query('SELECT * FROM people')
  .then((res) => {
    console.log(res.rows);
    client.end();
  })
  .catch((e) => {
    console.error(e);
    client.end();
  });
```

***

## async await select

<!-- eslint-disable no-undef -->

```javascript
async function select() {
  try {
    const query = 'SELECT * FROM people';
    const res = await client.query(query);
    console.log(res.rows);
  } catch (e) {
    console.error('Error selecting', e);
  } finally {
    await client.end(); // alltaf keyrt
  }
}
select().catch(e => console.error(e));
```

***

## Parameterized insert

<!-- eslint-disable no-undef -->

```javascript
const query = `INSERT INTO people (name, text)
VALUES($1, $2) RETURNING *`;
const values = ['Foo', 'Foo bar'];

client.query(query, values, (err, res) => {
  if (err) {
    console.error(err);
    return;
  }
  console.log(res.rows);
  client.end();
});
```
